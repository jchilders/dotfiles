#!/usr/bin/env zsh
set -euo pipefail

# usage: exifsearch <pattern> [dir]
pattern="${1:?usage: ${0:t} <pattern> [dir]}"
root="${2:-.}"
root="${~root}"

# File extensions glob (zsh extended glob)
exts="jpg|jpeg|png|heic|heif|tif|tiff|webp|arw|cr2|cr3|nef|dng|raf|orf|rw2"

# zsh globbing with null delimiters for safety
export EXIFSEARCH_PATTERN="$pattern"
jobs="${EXIFSEARCH_JOBS:-8}"
setopt extended_glob null_glob glob_star_short
files=("$root"/**/*.(#i)(${~exts})(.))
(( ${#files} == 0 )) && exit 0
printf '%s\0' -- $files[@] |
parallel -0 --no-notice --jobs "$jobs" --will-cite --env EXIFSEARCH_PATTERN \
  'if exiftool -s -s -s -a -G1 -charset filename=utf8 -FileName -FilePath -all:all -- {} 2>/dev/null \
    | rg -q -F -- "$EXIFSEARCH_PATTERN"; then
      printf "%s\n" {}
    fi'
